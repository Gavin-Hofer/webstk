# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

Use `pnpm` (not npm or yarn) as the package manager.

```bash
pnpm dev          # Start dev server with Turbopack at localhost:3000
pnpm build        # Production build
pnpm lint         # ESLint
pnpm format       # Prettier (write)
pnpm format:check # Prettier (check only)
pnpm test         # Run all tests with Vitest
```

Run a single test file:

```bash
pnpm vitest run src/lib/datastructures/deque.test.ts
```

Type-check without building:

```bash
pnpm tsc --noEmit
```

## Architecture

**Next.js 15 App Router** with React 19. Path alias `@/` maps to `./src/`.

### Directory Structure

- `src/app/` — Pages and layouts using App Router. Each tool has a dedicated subdirectory (`image-converter/`, `password-generator/`, `auto-formatter/`, `qr-code-generator/`) with `page.tsx` and a `components/` folder for page-specific components.
- `src/components/` — Shared components:
  - `ui/` — Primitive UI components built on Radix UI (shadcn/ui pattern)
  - `layout/` — App shell (Header, Body, ParallaxBackgroundGrid)
  - `context/` — React context providers (ReactQuery, Theme)
  - `icons/` — Custom SVG icons
- `src/hooks/` — Client-only React hooks (marked with `import 'client-only'`)
- `src/lib/` — Pure utilities, organized by domain:
  - `client/` — Browser-only code: image conversion pipeline, IndexedDB cache, file download
  - `datastructures/` — Deque implementation
  - `promises/` — `promisePool` / `promisePoolGenerator` for concurrency-limited async execution
  - `validation/` — Input validation helpers
  - `utils.ts` — `cn()` (clsx + tailwind-merge), `retry()` (exponential backoff), `replaceFileExtension()`
  - `errors.ts` — Custom error types (e.g., `ValueError`)

### Image Conversion Pipeline

The image converter (`src/lib/client/image-tools/`) uses a unified **wasm-vips** architecture:

1. **`convert-image.ts`** — Orchestrator: computes SHA-256 hash for IndexedDB caching, calls `convertImageVips()`, retries on failure with exponential backoff.
2. **`convert-image-vips.ts`** — Worker wrapper: spawns a Web Worker, posts `{file, options}`, validates the response with Zod, and returns a `File`.
3. **`convert-image-vips.worker.ts`** — WASM worker: loads `wasm-vips` from `/vips.wasm` (public dir, copied from `@denodecom/wasm-vips` at install time), performs the actual encode/resize.
4. **`cache.ts`** — LRU-style IndexedDB cache (`app-cache` DB) with max 10,000 entries, keyed by `{options, checksum}`.

Supported output formats: PNG, JPEG, WebP, GIF, BMP, TIFF, AVIF. The `/public/vips.wasm` binary is generated by the `postinstall` script and is not committed to the repo.

### State Management

- **URL state**: `nuqs` (wrapped in `NuqsAdapter` in the root layout) — used in QR Code Generator
- **Server state / async**: TanStack Query (`ReactQueryClientProvider` in root layout)
- **Persistent file storage**: IndexedDB (`ImageConverterDB`) managed by `usePersistentImages` hook
- **User preferences**: `localStorage` via `usehooks-ts` (e.g., preferred image format)

### Code Style

Prettier config (in `package.json`): single quotes, 2-space indent, trailing commas, `printWidth: 80`, `prettier-plugin-tailwindcss` for class sorting.

Sections within files are delimited with `// #region <Name>` / `// #endregion` comments.

ESLint extends `next/core-web-vitals` and `next/typescript` with `@next/next/no-img-element` turned off.
